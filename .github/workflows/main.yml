name: OpenClaw Telegram Bot

on:
  workflow_dispatch:

jobs:
  openclaw:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # ---------------------------
      # Setup Node 22
      # ---------------------------
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Verify Node
        run: node -v

      # ---------------------------
      # Install pnpm
      # ---------------------------
      - name: Install pnpm
        run: |
          npm install -g pnpm
          pnpm -v

      # ---------------------------
      # Install OpenClaw
      # ---------------------------
      - name: Install OpenClaw
        run: |
          git clone https://github.com/openclaw/openclaw.git
          cd openclaw
          pnpm install

      # ---------------------------
      # Configure Telegram
      # ---------------------------
      - name: Configure OpenClaw
        run: |
          cd openclaw
          echo "CHANNELS=telegram" > .env
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
          echo "ALLOW_SHELL=false" >> .env

      # ---------------------------
      # Start OpenClaw
      # ---------------------------
      - name: Start OpenClaw
        run: |
          cd openclaw
          pnpm start &
          sleep 10

      # ---------------------------
      # Send Test Message
      # ---------------------------
      - name: Send Telegram Test
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="OpenClaw is running âœ…"

      # ---------------------------
      # Keep Runner Alive
      # ---------------------------
      - name: Keep Alive
        run: sleep 6h
